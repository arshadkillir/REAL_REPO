const { Order, OrderItem, MenuItem, Table } = require('../models'); async function createOrder(req,res){ const tenantId = req.tenantId || req.body.tenantId || null; const { type, tableId, customerName, items=[] } = req.body; const order = await Order.create({ type, tableId: tableId||null, customerName, tenantId }); let total=0; for(const it of items){ let price = it.price||0; let name = it.name||''; if(it.menuItemId){ const m = await MenuItem.findByPk(it.menuItemId); if(m){ price=m.price; name=m.name; } } total += price*(it.quantity||1); await OrderItem.create({ orderId: order.id, menuItemId: it.menuItemId||null, name, quantity: it.quantity||1, price }); } order.total = total; await order.save(); if(order.tableId){ const t = await Table.findByPk(order.tableId); if(t){ t.status='occupied'; await t.save(); } } try{ if(global.io){ global.io.to('tenant_'+tenantId).emit('order_created',{ orderId: order.id, tenantId }); } }catch(e){} res.json(order); } async function listOrders(req,res){ const tenantId = req.tenantId || req.query.tenantId || null; const where = {}; if(tenantId) where.tenantId = tenantId; res.json(await Order.findAll({ where, order:[['createdAt','DESC']] })); } module.exports = { createOrder, listOrders };